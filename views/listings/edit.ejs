<% layout("layouts/boilerplate") %>

<div style="height: 2rem;"></div>
<div class="container">
<div class="row mt-3">
    <div class="col-8 offset-2 ">

    <h3>Edit your listings</h3>
    <form method="post" action="/listings/<%= listing._id %>?_method=PUT" novalidate class="needs-validation" enctype="multipart/form-data">

        <div class="mb-3">
           <label for="title" class="form-label">Title</label>
           <input name="listing[title]" value="<%= listing.title %>" type="text" class="form-control" required>
           <div class="valid-feedback">Title looks good!</div>
        </div>

        <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea name="listing[description]" class="form-control" required><%= listing.description %></textarea>
            <div class="invalid-feedback">Please enter a short description</div>
        </div>

        <div class="mb-3">
            Thumbnail Image<br><br>
            <img src="<%=originalImageUrl%>"  class="preview-img">
        </div>

        <div class="mb-3">
          <label class="form-label">Manage Images (Max 5)</label><br>

             <div id="image-container" class="d-flex flex-wrap gap-3">
                <% if (listing.images && listing.images.length > 0) { %>
                  <% listing.images.forEach((img) => { %>
                     <div class="image-box">
                       <img src="<%= img.url %>" alt="Listing Image" class="preview-img">
                          <button 
  type="button" 
  class="btn btn-sm btn-outline-danger del-btn" 
  onclick="deleteImage('<%= listing._id %>', '<%= img._id %>')">
  <i class="fa-solid fa-trash"></i> Delete
</button>

                       </div>
                 <% }) %>
              <% } %>

              <% for (let i = (listing.images ? listing.images.length : 0); i < 5; i++) { %>
                 <div class="image-upload-slot">
                    <label for="image-slot-<%= i %>" class="upload-placeholder">
                    <i class="fa-solid fa-plus"></i><br>Add Image
                    </label>

                  <input
                  type="file"
                  id="image-slot-<%= i %>"
                  name="images"
                  accept="image/*"
                  class="hidden-input"
                  onchange="previewImage(event, this)"
                  >
               <div class="image-preview"></div>
             </div>
           <% } %>
          </div>

          <% if ((listing.images && listing.images.length) >= 5) { %>
              <p class="text-muted mt-2">You have reached the 5-image limit.</p>
          <% } %>
        </div>

          <script>
           // ðŸ”¥ Confirm delete before submitting
          function confirmDelete(btn) {
           if (confirm("Are you sure you want to delete this image?")) {
           btn.closest("form").submit();
          }
         }

         // âœ… Show image preview without removing input
          function previewImage(event, input) {
          const file = event.target.files[0];
          const previewDiv = input.parentElement.querySelector(".image-preview");

          if (file) {
           const reader = new FileReader();
           reader.onload = function (e) {
           previewDiv.innerHTML = `
           <img src="${e.target.result}" class="preview-img">
           <p class="text-muted small mt-1 mb-0">Ready to upload</p>
          `;
        };
        reader.readAsDataURL(file);
        } else {
        previewDiv.innerHTML = "";
       }
     }
        </script>
        
        <div class="row">
            <div class="mb-3 col-md-4">
            <label for="price" class="form-label">Price</label>
            <input name="listing[price]" class="form-control" value="<%= listing.price %>"  type="number" class="form-control" required>
            <div class="invalid-feedback">Please enter your price</div>
        </div>

        <div class="mb-3 col-md-4">
            <label for="country" class="form-label">Country</label>
            <input name="listing[country]" value="<%= listing.country %>"  type="text" class="form-control" required>
            <div class="invalid-feedback">Please enter your country name</div>
        </div>

        <div class="mb-3 col-md-4">
            <label for="category" class="form-label">Category</label>
            <select name="listing[category]" id="category" class="form-select" required>
                <option value="" disabled selected>Select a category</option>
                <option value="Trending" <%= listing.category === "Trending" ? "selected" : "" %>>Trending</option>
                <option value="Rooms" <%= listing.category === "Rooms" ? "selected" : "" %>>Rooms</option>
                <option value="Iconic cities" <%= listing.category === "Iconic cities" ? "selected" : "" %>>Iconic cities</option>
                <option value="Beach" <%= listing.category === "Beach" ? "selected" : "" %>>Beach</option>
                <option value="Lake front" <%= listing.category === "Lake front" ? "selected" : "" %>>Lake front</option>
                <option value="Camping" <%= listing.category === "Camping" ? "selected" : "" %>>Camping</option>
                <option value="Farms" <%= listing.category === "Farms" ? "selected" : "" %>>Farms</option>
                <option value="Cabin" <%= listing.category === "Cabin" ? "selected" : "" %>>Cabin</option>
                <option value="Mountains" <%= listing.category === "Mountains" ? "selected" : "" %>>Mountains</option>
                <option value="Castles" <%= listing.category === "Castles" ? "selected" : "" %>>Castles</option>
                <option value="Arctic" <%= listing.category === "Arctic" ? "selected" : "" %>>Arctic</option>
            </select>
            <div class="invalid-feedback">Please select a category</div>
        </div>
        </div>
        
        <div class="mb-3">
            <label for="location" class="form-label">location</label>
            <input name="listing[location]" value="<%= listing.location %>" type="text" class="form-control" required>
            <div class="invalid-feedback">Please enter your location</div>
        </div>

        <button type="submit" class="btn btn-dark edit-btn mt-3 mb-5">Edit</button>
    </form>
   </div>
</div>
</div>
<script src="/js/script.js"></script>
<script>
async function deleteImage(listingId, imageId) {
  if (!confirm("Are you sure you want to delete this image?")) return;

  try {
    const res = await fetch(`/listings/${listingId}/images/${imageId}?_method=DELETE`, {
      method: "POST" // Method override will convert it to DELETE
    });

    if (res.ok) {
      alert("Image deleted successfully!");
      location.reload();
    } else {
      alert("Failed to delete image.");
    }
  } catch (err) {
    console.error(err);
    alert("Error deleting image.");
  }
}
</script>
